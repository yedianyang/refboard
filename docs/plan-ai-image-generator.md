# AI Image Generator — 功能规划

> 日期：2026-02-17  
> 状态：待开发  
> 优先级：P2（字体功能完成后）

---

## 设计参考

**设计稿位置：** `docs/reference/ai-generator-design-ref.png`

**核心理念：** 将 AI 图像生成无缝集成到画板工作流，参考图和生成图在同一画布。

---

## 功能需求

### 1. 画板底部全局输入框

**位置：** 画板底部中央，固定位置  
**宽度：** 占据画板宽度 60-80%  
**功能切换：** 同一输入框支持两种模式

**输入框 UI：**
```
┌──────────────────────────────────────────────────────────┐
│  今天我们要创作什么                                        │
│                                                          │
│  🤖 Nano Banana Pro ▾   📐 1K ▾   1:1 ▾   ⚡10          │
└──────────────────────────────────────────────────────────┘
```

### 2. 两种工作模式

#### 模式 A：搜索现有图片
- **触发：** 输入框没有特殊标记，直接输入文本
- **行为：** 搜索项目中已有的图片（CLIP 语义搜索 + FTS5 文本搜索）
- **结果：** 高亮匹配的卡片，或在侧边栏显示搜索结果

#### 模式 B：AI 生成新图片
- **触发：** 点击"生成"按钮或特定快捷键（Cmd+G）
- **行为：** 调用 AI 图像生成 API
- **结果：** 生成的图片直接成为画板上的 Image Card

### 3. 控制面板（底部输入框下方）

| 控件 | 功能 | 选项 |
|------|------|------|
| **模型选择** | 切换 AI 生成服务 | ~~Nano Banana Pro~~ → 待确认（DALL-E 3 / Gemini Imagen / SD） |
| **分辨率** | 控制生成图片大小 | 1K (1024×1024) / 2K / 4K |
| **比例** | 图片宽高比 | 1:1 / 16:9 / 3:2 / 2:3 / 9:16 |
| **生成数量** | 一次生成多少张 | 1-10 张（⚡图标 + 数字） |

### 4. 生成结果集成

**流程：**
1. 用户输入提示词，点击"生成"
2. 画板上出现占位符（蓝色半透明矩形，显示"生成中..."）
3. API 返回后，占位符变为 Image Card
4. 图片自动保存到 `images/` 目录
5. 支持拖拽、标签、聚类等所有常规操作

**占位符设计：**
```
┌─────────────────────┐
│                     │
│   🎨 生成中...      │
│   [进度条]          │
│                     │
└─────────────────────┘
```

### 5. 后端集成

**需要集成的 AI 服务：** 待 Jingxi 确认

**候选方案：**
- **DALL-E 3** (OpenAI) — 质量高，API 成熟
- **Gemini Imagen** (Google) — 免费额度
- **Stable Diffusion** (本地) — 完全离线
- **Midjourney API** (非官方) — 质量最佳但不稳定

**后端需要新增：**
- Tauri 命令：`cmd_generate_image(prompt, model, width, height, count)`
- HTTP client 调用 AI API
- 图片下载和保存逻辑
- 错误处理（API 限流、生成失败）

---

## 技术方案

### 前端（JavaScript）

**新增模块：** `desktop/src/canvas/ai-generator.js`

**主要功能：**
- 渲染全局输入框（底部固定）
- 模式切换（搜索 vs 生成）
- 控制面板 UI（模型/分辨率/比例/数量）
- 占位符创建和替换
- 调用后端 API

### 后端（Rust）

**新增模块：** `desktop/src-tauri/src/ai_generator.rs`

**主要功能：**
- HTTP client（reqwest）
- API 密钥管理（从配置文件读取）
- 图片下载和保存
- 错误处理和重试

### 配置文件

**新增字段：** `deco.json`

```json
{
  "ai_generator": {
    "enabled": true,
    "default_model": "dall-e-3",
    "api_keys": {
      "openai": "sk-...",
      "google": "..."
    },
    "default_resolution": "1K",
    "default_aspect_ratio": "1:1",
    "default_count": 4
  }
}
```

---

## UI 设计规范

### 输入框样式

**字体：** SF Pro（与全局一致）  
**字号：** 15px（Body 级别）  
**高度：** 48px  
**圆角：** 8px  
**阴影：** `var(--shadow-md)`  
**背景：** `var(--surface)`

### 控制面板样式

**布局：** 水平排列，间距 16px  
**字号：** 13px（Caption 级别）  
**下拉菜单：** 与 Settings 面板风格一致

---

## 开发计划

### Phase 1: 基础框架（1 周）
- [ ] 前端：底部全局输入框 UI
- [ ] 前端：模式切换逻辑
- [ ] 后端：API 密钥配置
- [ ] 后端：HTTP client 基础

### Phase 2: 生成功能（1 周）
- [ ] 后端：集成 AI API（待确认服务）
- [ ] 前端：占位符创建
- [ ] 前端：生成结果 → Image Card
- [ ] 图片保存到 `images/`

### Phase 3: 控制面板（3 天）
- [ ] 模型选择下拉菜单
- [ ] 分辨率/比例/数量控制
- [ ] 参数持久化到配置

### Phase 4: 搜索集成（3 天）
- [ ] 模式 A：调用现有搜索功能
- [ ] 快捷键切换（Tab 或 Cmd+K）

### Phase 5: 优化（3 天）
- [ ] 错误处理和提示
- [ ] 生成历史记录
- [ ] 批量生成进度显示

---

## 待确认问题

**由 Jingxi 决定：**

1. **AI 服务选择：** DALL-E 3 / Gemini Imagen / Stable Diffusion？
2. **优先级：** 
   - 先完成字体功能（CSS 已完成，还差 Rust + Settings UI）
   - 再开发 AI Generator？
   - 还是并行？
3. **API 密钥：** 谁提供？存储在哪里？

---

**下一步：** 等 Jingxi 确认上述问题后，Team Lead 拆分任务并分配给 teammates。
