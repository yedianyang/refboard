# Deco 创建项目流程图

## 当前流程（有 Bug）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户操作                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Home 页面                                                                   │
│  ┌──────────────┐  ┌──────────────┐                                         │
│  │   + New      │  │    Open      │                                         │
│  └──────────────┘  └──────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  New Project Dialog                                                          │
│  ┌─────────────────────────────────────────────┐                            │
│  │  Project Name: [___Art Deco___________]     │                            │
│  │                                             │                            │
│  │  Path Preview: ~/Documents/Deco/Art Deco/                            │
│  │                                             │                            │
│  │           [Cancel]  [Create]                │                            │
│  └─────────────────────────────────────────────┘                            │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          │ 点击 Create
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  前端 main.js                                                                │
│                                                                             │
│  await invoke('cmd_create_project', { name })                               │
│                    │                                                        │
│                    │  ❌ 命令名错误！                                        │
│                    │  ❌ 只传了 name，没传 path！                            │
│                    ▼                                                        │
│              Tauri IPC                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          │ 找不到 cmd_create_project
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  后端 lib.rs                                                                 │
│                                                                             │
│  ❌ 没有 cmd_create_project 命令                                            │
│                                                                             │
│  ✅ 有 create_project(name, path) 但名字不匹配                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          │ 返回错误
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  前端 Fallback 逻辑                                                          │
│                                                                             │
│  catch (err) {                                                              │
│    const home = await getHomePath();                                        │
│    const path = `${home}Documents/Deco/${name}`;  // ❌ 路径拼接问题     │
│    openProject(path, loading);  // 目录不存在，报错                          │
│  }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ❌ 结果：Error: Path does not exist                                        │
└─────────────────────────────────────────────────────────────────────────────┘


## 正确流程（修复后）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户操作                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Home 页面                                                                   │
│  ┌──────────────┐  ┌──────────────┐                                         │
│  │   + New      │  │    Open      │                                         │
│  └──────────────┘  └──────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  New Project Dialog                                                          │
│  ┌─────────────────────────────────────────────┐                            │
│  │  Project Name: [___Art Deco___________]     │                            │
│  │                                             │                            │
│  │  Path Preview: ~/Documents/Deco/Art Deco/                            │
│  │                                             │                            │
│  │           [Cancel]  [Create]                │                            │
│  └─────────────────────────────────────────────┘                            │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          │ 点击 Create
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  前端 main.js                                                                │
│                                                                             │
│  // 方案 A: 前端构造路径                                                     │
│  const home = await getHomePath();                                          │
│  const path = `${home}/Documents/Deco/${name}`;                         │
│  await invoke('create_project', { name, path })                             │
│                                                                             │
│  // 或方案 B: 后端自动构造路径                                               │
│  await invoke('cmd_create_project', { name })                               │
│                    │                                                        │
│                    ▼                                                        │
│              Tauri IPC                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  后端 lib.rs                                                                 │
│                                                                             │
│  #[tauri::command]                                                          │
│  fn create_project(name: String, path: String) {                            │
│      // 1. 创建目录结构                                                      │
│      fs::create_dir_all(path/images/)                                       │
│      fs::create_dir_all(path/thumbnails/)                                   │
│                                                                             │
│      // 2. 写入配置文件                                                      │
│      write(deco.json)   // 项目配置                                     │
│      write(metadata.json)   // 元数据                                       │
│      write(board.json)      // 画布状态                                     │
│                                                                             │
│      // 3. 添加到最近项目                                                    │
│      add_to_recent(name, path)                                              │
│                                                                             │
│      return { name, path, image_count: 0 }                                  │
│  }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  前端收到返回                                                                │
│                                                                             │
│  const result = { name: "Art Deco", path: "/.../Art Deco", image_count: 0 } │
│  projectPathInput.value = result.path;                                      │
│  openProject(result.path);  // 打开新建的空项目                              │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ 结果：空的画布，可以开始添加图片                                         │
└─────────────────────────────────────────────────────────────────────────────┘


## 项目目录结构

```
~/Documents/Deco/
└── Art Deco/                    # 项目根目录
    ├── deco.json            # 项目配置 (version, name, created)
    ├── metadata.json            # 项目元数据 (name, path, tags, image_count)
    ├── board.json               # 画布状态 (viewport, items, groups, annotations, connections)
    ├── images/                  # 原始图片
    │   ├── image1.jpg
    │   └── image2.png
    └── thumbnails/              # 缩略图缓存
        ├── image1.webp
        └── image2.webp
```

## 需要修复的代码

### main.js (第 775 行附近)

```diff
- const result = await invoke('cmd_create_project', { name });
+ const home = await getHomePath();
+ const basePath = home.endsWith('/') ? home : home + '/';
+ const path = `${basePath}Documents/Deco/${name}`;
+ const result = await invoke('create_project', { name, path });
```

### 或者 lib.rs (新增命令)

```rust
#[tauri::command]
fn cmd_create_project(name: String) -> Result<ProjectInfo, String> {
    let home = dirs::home_dir()
        .ok_or("Cannot find home directory")?;
    let path = home
        .join("Documents")
        .join("Deco")
        .join(&name);
    create_project(name, path.to_string_lossy().to_string())
}
```
